<template>
  <div id="mainSorterView">
    <b-icon class="returnToHomeButton" icon="arrow-left-circle-fill" font-scale="2" variant="dark" @click="openPage('')"></b-icon>
    <!-- <img class="logo" :src="logo"/> -->
    
    <div class="welcomeInstructions" v-if="welcomeInstructions">
      <h3>Welcome to the Vulnerability Sorter</h3>
      <p>Use the <u>arrow keys</u> on the keyboard to guess the security status of components.</p>
      <p>The <b style="color:red;">left</b> arrow marks a vulnerable component, and the <b style="color:green;">right</b> arrow marks a safe one.</p>
      <br>
      <b-button variant="outline-success" size="lg" @click="iterateData()">
        <b-icon icon="play-fill"></b-icon> Play
      </b-button>
    </div>
    
    
    <div class="result" v-if="resultImage.length>1" >
      <b-icon v-if="resultImage=='correct'" icon="check-circle" scale="2" variant="success"></b-icon>
      <b-icon v-else icon="x-circle" scale="2" variant="danger"></b-icon>
      <h3 v-if="resultImage=='correct'" style="color:#28a745; margin-top:18px;">Correct!</h3>
      <h3 v-else style="color:#dc3545; margin-top:18px;">Incorrect!</h3>
      <!-- <img class="result" v-if="resultImage.length>1" :src="'/img/'+resultImage" /> -->
    </div>


    <canvas id="sortCanvas" :width="screen.x" :height="screen.y">
    </canvas>

    <div class="details" v-if="!classTrigger">
      <h1 v-if="component.vulnerability.length >1">{{component.vulnerability}}</h1>
      <h1 v-else>Non-Vulnerable Component!</h1>
      <p>{{component.vulnDescription}}</p>
    </div> 

    <div class="instructions"> 
      <span>
        <!-- <p>Use Arrow Keys</p> -->
        <b-icon class="icon" icon="arrow-left-circle" scale="2" variant="danger"></b-icon>
        <b-icon class="icon" icon="arrow-right-circle" scale="2" variant="success"></b-icon>
        <p>Bad - Safe</p>
      </span>
      <h1>000{{score}}</h1>
    </div>

    <video id="videoFeed" autoplay></video>
  </div>
</template>

<script>
import axios from 'axios'

export default {
  name: 'VulnerabilitySort',
  props: {
    
  },
  components: {

  },
  data(){
    return{
      logo:"/img/hexagon.png",
      screen:{
        x:0,
        y:0
      },

      welcomeInstructions:true,
      canvas:null,
      ctx:null,
      hexA: 2 * Math.PI / 6,
      radius: 110,
      components: null,
      component:null,
      classTrigger:true,
      resultImage:"",
      animationInterval: null,
      score:0

      
    }
  },
  created() {
    this.screen.x = window.screen.width;
    this.screen.y = window.screen.height;
    // console.log(this.screen.x +" - "+this.screen.y )
  },

  mounted() {

    window.addEventListener('keydown', (e) => {
      if(e.key == "ArrowRight" || e.key == "ArrowLeft" ){
        this.getUserInput(e.key)
      }

      if(e.key == "Enter"){
        this.getUserInput(e.key)
      }
      
    });

    //Draw canvas
    this.createScene();

    // this.startVideoFeed();
  },


  methods: {
    openPage: function(e) {
      this.$router.push("/"+e);
    },


    createScene: async function(){
      //Read components list
      await axios.get('./data/component-data.json').then(response => {
          this.components = response.data;
          console.log("jsonData:", this.components);
      }).catch(err => {
          console.log("Error Reading JSON: ",err);
      });

      //Create Canvas
      this.canvas = document.getElementById('sortCanvas');
      this.ctx = this.canvas.getContext('2d');

      // this.iterateData()

      // let that = this;
      // setTimeout(function(){
      //   that.iterateData()
      // },1000)     
    },


    iterateData: function(){
      this.welcomeInstructions = false;

      if(this.components.length>0){
        this.ctx.clearRect(0, 0, this.screen.x, this.screen.y); // Reset canvas
        let itemIndex = Math.floor(Math.random() * this.components.length)
        this.component = this.components.splice(itemIndex, 1)[0]
        this.triggerVulnerability();
      }else{
        console.log("Done!")
      }
    },


    triggerVulnerability: function(){
      var margin = 200;
      var start = Math.floor(Math.random() * (this.screen.x- (2*margin))) + margin;
      this.ctx.textAlign = "center";

      // Animation details
      let backForward = Math.floor(Math.random() * 2)
      if(backForward == 0){
        backForward = -1;
      }
      let yPos = 0;
      // let xWiggle = Math.floor(Math.random() * 50);

      // Draw to Canvas
      this.animationInterval = setInterval(() => {
        this.ctx.clearRect(0, 0, this.screen.x, this.screen.y); // Reset canvas
        
        yPos += 2; //Glide down
        this.drawVulnerabilityToCanvas(start,yPos)

        // When it hits the bottom flash red and reset
        if(yPos > this.screen.y-120){
          clearInterval(this.animationInterval)
          let mainView = document.getElementById("mainSorterView");
          mainView.setAttribute("style", "background-color: red;");
          this.classTrigger = false;

          setTimeout(function(){
            mainView.setAttribute("style", "background-color: transparent;");
          }, 300);

          let that = this
          setTimeout(function(){
            that.iterateData()
            that.classTrigger = true;
          }, 2000);
          
        }
      }, 20);
    },


    drawVulnerabilityToCanvas: function(x,y){
      // Spinning animation: https://www.youtube.com/watch?v=aO1VcJ5WpKI
      // this.ctx.translate(this.canvas.width / 2, this.canvas.height / 2);
      // this.ctx.rotate(y * (Math.PI / 180));

      this.ctx.font = "20px Arial";
      this.ctx.fillText(this.component.format, x, y-42);
      this.ctx.fillText(this.component.version, x, y+56);

      let fontSize = 34;
      if( this.component.name.length>10 && this.component.name.length<20){
        fontSize = 23;
      }else if(this.component.name.length>=20){
        fontSize = 16;
      }
      this.ctx.font = "bold "+fontSize+"px Arial";
      this.ctx.fillText(this.component.name, x, y+6);
  
      this.ctx.beginPath();
      this.ctx.lineWidth = 9;
      this.ctx.strokeStyle = "#5824D8";
      for (var i = 0; i < 6; i++) {
        this.ctx.lineTo(x + this.radius * Math.cos(this.hexA * i), y + this.radius * Math.sin(this.hexA * i));
      }

      this.ctx.closePath();
      this.ctx.stroke();
    },


    // animateVulnerability: function(backForward){
    //   // this.ctx.translate((this.screen.x/2), (this.screen.y/2));
    //   // Spin item
    //   // degree +=1;
    //   // this.ctx.rotate(10 * Math.PI / 180);
    //   // this.ctx.rotate(backForward * 10 * (Math.PI / 180));
    //   console.log(backForward)
    // },


    getUserInput: function(key){
      if(this.classTrigger == true){
        this.classTrigger = false;
        let mainView = document.getElementById("mainSorterView");
        clearInterval(this.animationInterval)
        // console.log(key)
        switch(key){
          case 'ArrowLeft':
            if(this.component.cveScore>5){
              // console.log("CORRECT! VULNERABLE!")
              this.score+=10;
              this.resultImage = "correct"
              mainView.setAttribute("style", "background-color: green;");
            }else{
              // console.log("INCORRECT! VULNERABLE!")
              this.resultImage = "incorrect"
              mainView.setAttribute("style", "background-color: red;");
            }
            break;
          case 'ArrowRight':
            if(this.component.cveScore<5){
              // console.log("CORRECT! NOT VULNERABLE!")
              this.score+=10;
              this.resultImage = "correct"
              mainView.setAttribute("style", "background-color: green;");
            }else{
              // console.log("INCORRECT! CORRECT! NOT VULNERABLE!")
              this.resultImage = "incorrect"
              mainView.setAttribute("style", "background-color: red;");
            }
            break;
        }

        //Turn off color flash
        setTimeout(function(){
          mainView.setAttribute("style", "background-color: transparent;");
        }, 300);

        let timeout = 3000
        if(this.component.vulnerability.length >1){
          timeout = 15000;
        }

        let that = this;
        setTimeout(function(){
          that.resultImage = "";
          that.classTrigger = true;
          that.iterateData()
        },timeout)
      }
    },

    startVideoFeed: async function(){
      var video = document.getElementById('videoFeed');

      if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia){
        await navigator.mediaDevices.getUserMedia({video:true}).then((stream) => {
          video.srcObject = stream;
          video.play();
        }) //sound:true
      }
      // https://www.youtube.com/watch?v=nhX9EUGIZ6o

      
      const resp = await axios.post('https://httpbin.org/post', { hello: 'world' })
      console.log(resp.data.json)
      // setInterval(function(){
      //   axios.post()
      // }, 100);
    },

    completeGame: function(){
      //FINISH!!!!
      this.$store.commit('updateProgress', {route:this.$route.name, context:this, score:1000});

    }


  },

  // beforeRouteLeave (to, from, next) {
  //   //Turn off camera
  //   var video = document.getElementById('videoFeed');
  //   const mediaStream = video.srcObject;
  //   const tracks = mediaStream.getTracks();
  //   tracks.forEach(track => track.stop())
  //   next();
  // },

   
}
</script>

<!-- Add "scoped" attribute to limit CSS to this component only -->
<style scoped>
#mainSorterView{
  text-align: center;
  /* padding: 2vw; */
  background-color: transparent;
  background-image:
    linear-gradient(to bottom, rgb(255, 255, 255),rgb(196, 212, 255));
  /* background-image:url('./img/sonatype.png');   */
    /* linear-gradient(to bottom, rgba(22, 22, 22, 0.85),rgba(0, 0, 0, 0.85)),  */
    
  /* background-repeat: no-repeat; */
}

.logo{
  width: 5vw;
  /* display: block; */
  /* margin: 15px auto; */
  position: fixed;
  left: 10px;
  bottom: 10px;
  /* background-color: rgba(0, 0, 0, 0.7);
  border-radius: 20px;
  box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.7); */
}

.welcomeInstructions{
  background-color: rgb(48, 48, 48);
  /* border: 2px solid rgb(32, 32, 32); */
  border-radius: 10px;
  position: fixed;
  right:32vw;
  top: 12vh;
  width: 36vw;
  padding: 15px;
  color: white;
  font-size: 24px;
  text-align: center;
}

.welcomeInstructions h3{
  color: white;
  font-size: 46px;
}

.instructions{
  position:fixed;
  bottom: -10px;
  left: 10px;
  font-size: 12px;
  display: flex;
  justify-content: flex-start;
  flex-wrap: nowrap;
}

.instructions h1{
  font-size: 60px;
  margin-left: 10px;
  margin-top: -18px;
}

.instructions .icon{
  margin: 0 10px 10px 10px;
  font-size: 16px;
}

.result{
  position: fixed;
  top:30px;
  right: 0px;
  /* width: 10vw; */
  font-size: 70px;
}

#sortCanvas{
  /* background: rgb(155, 69, 69); */
}

.details{
  background-color: rgba(125, 195, 233, 0.9);
  /* border: 2px solid rgb(32, 32, 32); */
  border-radius: 8px;
  position: fixed;
  right:10px;
  bottom: 10px;
  text-overflow: wrap;
  font-size: 26px;
  min-width: 30vw;
  max-width: 45vw;
  padding:10px;
  color: black;
  transition: 1s ease-in-out;
}

.slide{
  transition: 1s ease-in-out;
  right: -40vw;
}

#videoFeed{
  position: fixed;
  left:10px;
  bottom: 10px;
  width: 15vw;
}

</style>
